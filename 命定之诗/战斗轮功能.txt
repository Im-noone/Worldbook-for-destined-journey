<combat_round_protocol>
# 核心指令: 当触发任何战斗场景时,必须严格遵循本协议进行处理。

# --- 阶段一: 内部思考与演算 ---
# 在生成任何战斗描述前,必须在内部完成以下思考步骤:

# 0) 回合预生成骰子池:
# 核心规则: 本回合所有需要随机数的场合,都必须从此处的检定池中**严格按顺序取用**。你必须在内部维护每个池子的消耗索引(从1开始),每个数值仅能使用一次。
# d20检定池 (共60颗): {{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}},{{roll 1d20}}

1) 战型/层级/集群:
  战型=遭遇/精英/Boss/死斗; 烈度=最高生命层级→低(1-3)/中(4-5)/高(6-7);
  若敌同类≥3且层级≤玩家→进入集群流程。

2) 参战与聚合:
  列出 {{user}}/友军/敌军;
  集群: 先依<npc_generation_protocol>生成“模板个体”→聚合单位:
    名称=[模板]集群; 总HP/MP/SP=单体×数量; 五维=单体; 击杀阈值=模板HP;
    参战列表仅留“集群”。
  部队: 参考<army_number_represent_protocol>与<army_info_template_protocol>生成合适的个体模板后生成集群

3) 同步属性与加持:
  依<npc_generation_protocol>确认各单位当前 HP/MP/SP、力/敏/体/智/精 与持有的 要素/权能/法则;
  记录装备附魔/特殊: 精准/锋锐/雷电/烈焰/微弱要素/微弱法则。

4) 神国判定:
  若战场处于某神国→记录主宰者(供规则宣告使用)。

5) 行动序列检定(只检定序列，不包括逃跑等行为):
  规则: 依参战单位列表, 从池中按顺序取出数值, 作为各单位的先攻掷骰结果。
  计算: 各单位先攻值 = 敏捷×3 + 对应的池数值。

6) 顺序修正与排序:
  若持有【疾速】等影响顺序的要素或装备含【微弱时-空法则】→此处修正;
  以总值高→低生成本回合行动轴。

7) 回合开始(单位):
  当前行动者=[单位]; 若其为神国主宰且位于其神国→可宣告当回合临时规则(例: 火焰伤害×2)。

8) 行动拆分:
  **每单位每回合 [攻击]×1 + [动作]×1;无法多动**
  若发动[权能]或[法则]主动效果→同时消耗本回合[攻击]+[动作]。

9) 攻击流程:
  a) 目标; b) 类型=普攻/物理技/魔法术;
  c) 集群出手次数按当前HP%: >70%→3次; 30%-70%→2次; ≤30%→1次;
  d) 装备检定<装备生成规则>: 精准(命中修正)/锋锐(伤害修正)/雷电·烈焰(附伤/状态)/微弱要素(概率);
  e) 命中: 从池中顺序取出下一个未使用的数值作为本次攻击的命中骰(r0)。若一回合内进行多次攻击(如集群或特殊技能)，则每次攻击都必须独立地、顺序地从池中取出新的数值进行检定。
     r1 = r0 + 精准修正(装备精准附魔); 判定: r1≥19=暴击; 6≤r1<16=命中; r1<7=落空;
  f) 伤害: 最终伤害 = ((技能基准威力 + 技能所需对应单属性(技能对应属性参考dnd)×10) × 武器乘数 + 锋锐附魔伤害) × 层级乘数 - (目标方防具基础防御 + 目标方防具坚韧附魔防御); 暴击×1.5;
     紧凑参考:
       技能威力: 普攻5/普10/优20/稀50/史110/传270/神1400
       层级乘数: 1:1.5/2:2.0/3:2.5/4:3.0/5:3.5/6:4.0/7:5.0
       武器乘数: 无1/普1.5/优2.0/稀2.5/史3.0/传3.5/神4.0
       防具防御: 无0/普5/优10/稀25/史60/传140/神700
  g) 更新目标HP;
  h) 要素/法则/附魔结算与状态:
     若状态检定→ 从池中顺序取出两个未使用的数值, 分别作为施加方检定骰(s1)和目标豁免骰(s2)。
     [施加方智/力]+s1 vs [目标体/精]+s2; 任一掷20为大成功。

10) 动作流程:
  a) 类型=用道具/辅法/权能/装备用能/法则主动/尝试逃跑;
  b) 权能对抗(若目标为强意志): 从池中顺序取出两个未使用的数值, 分别作为行动者强度检定骰(p1)和目标抵抗检定骰(p2)。
     行动者精神+p1 vs 目标精神+p2 → 差值= 完美/正常/削弱/抵抗;
  c) {{user}}逃跑检定(若{{user}}输入意图行动类型为'尝试逃跑'):
     从池中顺序取出两个未使用的数值, 分别作为玩家检定骰(e1)和敌方检定骰(e2)。
     检定: (玩家敏捷+e1) vs (场上敏捷最高的敌人敏捷+e2)。
     若玩家方>敌方→逃跑成功, 战斗结束; 否则→逃跑失败, 消耗动作。
  d) 结算资源与状态。

11) 回合结束:
  若一方全灭或逃跑(仅敌人)→结算; 否则进入下个单位;
  非死斗的士气/逃跑检定: 资源阈值= 普40%/精20%/Boss10%;
  触发时从池中顺序取出下一个未使用的数值作为士气检定骰(r3); r3<5 敌逃跑; r3>13 敌入【美德】(效果二选一: 其下一次攻击必定暴击/下一次承受伤害全部减半)。
  如果为部队作战，士气清零视为被击溃，将部队HP清理并移除。且会影响其他部队(友方下降，敌方上升)

# --- 阶段二: 格式化输出 (保持 html 不变) ---
# 基于内部演算结果, 严格遵循“数据面板 + 去游戏化叙事”的双层结构输出。所有面板必须严格遵循此 html 部分的格式，**战斗轮CSS 内容已在外部处理，禁止生成，且只适用与战斗，不包括其它美化**。

<!-- 1) 战前状态展示 -->
<div class="cp sp">
  <div class="csf">
    <p class="cn">{{user}}</p>
    <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
    <p>力:X 敏:X 体:X 智:X 精:X</p>
  </div>
  <div class="csf">
    <p class="cn">[队友/召唤物/魔宠]</p>
    <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
    <p>力:X 敏:X 体:X 智:X 精:X</p>
  </div>
  <!-- 可重复友方块 -->
  <div class="cse">
    <p class="cn">[敌人名 / 集群名称 (xN)]</p>
    <p class="cr">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX</p>
    <p>力:X 敏:X 体:X 智:X 精:X</p>
  </div>
  <!-- 可重复敌方块 -->
</div>

<!-- 2) 行动顺序轴 -->
<div class="cp ao">
  <p class="ph">行动顺序检定:</p>
  <ul class="dl">
    <li><span class="hl">[角色A]:</span> 敏[X]×3 + 掷[Y] (+修正[Z]) = <span class="dr">[总值]</span></li>
    <li><span class="hl">[角色B]:</span> 敏[X]×3 + 掷[Y] (+修正[Z]) = <span class="dr">[总值]</span></li>
    <!-- 可继续列出 -->
  </ul>
  <p class="ph">最终顺序: [角色A] → [角色B] → [角色C] → ...</p>
</div>

<!-- 3) 行动轮次面板 · 攻击面板 -->
<div class="cp atk">
  <p class="ph">[攻击者]的攻击</p>
  <p class="sh">HP: XXX/XXX | MP: XXX/XXX | SP: XXX/XXX (-XX)</p>
  <p class="ph">命中检定:</p>
  <p>掷骰r0 + [装备名与附魔][精准附魔修正] = <span class="dr">r1</span> → 完美命中(暴击)! / 普通命中 / 未命中</p>

  <p class="ph">伤害计算式:</p>
  <ul class="dl">
    <li>基础伤害 = (力/体/敏/智/精[XX]×10) × 第x层级[层级乘数] = YYY</li>
    <li>技能修正 = 基础伤害[YYY] + [技能名][技能基准威力] × 第x层级[层级乘数] = ZZZ</li>
    <li>最终装备修正 = 技能修正[ZZZ] × [武器品质][武器乘数] + [武器名与附魔][锋锐附魔伤害] × 第x层级[层级乘数] - ([目标防具品质][目标防具基础防御] + [目标防具名与附魔][坚韧附魔防御])  = ZZZ × Y.Y + AA × C.C - (MMM + BB) =<span class="dm">NNN</span></li>
  </ul>

  <p class="ph">效果结算清单:</p>
  <ul class="rl">
    <li>✓ 使用[技能/普攻/武器/道具]攻击[目标名]。</li>
    <li>✓ 对目标造成 <span class="dm">NNN</span> 点伤害! ([目标] HP: YYY → ZZZ)</li>
    <li>✓ (若为集群) (伤害[NNN] > 击杀阈值[XXX]) → 你击杀了 <span class="hl">M</span> 名敌人!</li>
    <li>✓ [武器名][武器附魔] 触发: 额外造成 <span class="dm">XX</span> 点[元素]伤害!</li>
    <li>✓ [装备名][装备要素] 触发(XX%): [效果简述]。</li>
    <li>✓ [要素/法则状态] 触发: [效果简述]。</li>
    <li>施加: [施加方智/力] + 掷骰[s1] = XX → 豁免: [豁免方体/精] + 掷骰[s2] = XX → [豁免失败/豁免成功]</li>
  </ul>
</div>

<!-- 3) 行动轮次面板 · 动作面板 -->
<div class="cp act">
  <p class="ph">[行动者]的动作</p>
  <p class="sh">HP: XXX/XXX (+XX) | MP: XXX/XXX (-XX) | SP: XXX/XXX</p>

  <p class="ph">行动详情:</p>
  <ul class="dl">
    <li>行动类型: [使用道具 / 施展辅助法术 / 发动权能 / 发动装备能力 / 尝试逃跑]</li>
    <li>核心能力: [能力名称]</li>
    <li>资源消耗: [XX MP / XX SP / 25% 最大资源]</li>
  </ul>

  <p class="ph">权能对抗 (若触发):</p>
  <ul class="dl">
    <li>强度检定: [行动者精神] + 掷骰[p1] = XX</li>
    <li>抵抗检定: [目标精神] + 掷骰[p2] = YY</li>
    <li>结果: 完美生效 / 正常生效 / 效果削弱 / 抵抗成功</li>
  </ul>

  <p class="ph">逃跑检定 (若触发):</p>
  <ul class="dl">
    <li>你的检定: 敏[X] + 掷骰[e1] = XX</li>
    <li>敌人拦截: [最快敌人]敏捷[Y] + 掷骰[e2] = YY</li>
    <li>结果: 逃跑成功 / 逃跑失败</li>
  </ul>

  <p class="ph">效果结算清单:</p>
  <ul class="rl">
    <li>✓ [行动者] 发动了[能力名称]。</li>
    <li>✓ 自身/目标获得 状态/效果名 效果。</li>
    <li>✓ 战场环境发生变化: 变化简述。</li>
  </ul>
</div>

<!-- 4) 回合结束事件面板 (按需显示) -->
<div class="cp re">
  <p class="ph">回合结束检定</p>
  <p><b>触发条件:</b> [敌人名] 的资源低于阈值。</p>
  <p><b>士气检定:</b> 掷骰结果 [r3] → 结果</p>
  <p><b>最终结果:</b> 逃跑成功! / 逃跑失败! / 意志升华，进入【美德】状态!</p>
</div>

<!-- 5) 战斗结束面板 · 胜利/逃跑成功 -->
<!--  若战斗结束原因为玩家成功逃跑, 则此面板中【禁止】生成“获得EXP”和“获得FP”这两行。 -->
<div class="cp vic">
  <h4 class="ph">战斗胜利!/逃跑成功!</h4>
  <p class="ph">简述敌人的最终结局，如: 敌方全灭 / 目标被成功控制 / 敌人逃跑 / 你成功脱离了战斗。</p>
  <p>获得EXP: <span class="hl">+XXX EXP</span></p>
  <p>获得FP: <span class="hl">+XXX FP</span></p>
</div>

<!-- 5) 战斗结束面板 · 失败 -->
<div class="cp def">
  <h4 class="ph">战斗失败...</h4>
  <p class="ph">简述失败的直接后果，如: 玩家被击败 / 任务目标被摧毁。</p>
  <p class="no-italic">(强制进入失败剧情)根据胜利方敌人的性格与目标,不可避免地展开后续故事,如被俘虏、羞辱、洗劫等。</p>
</div>

instruction_narrative: |
  叙事守则:
  - 基于<fiction_style>
  - 避免回合制游戏叙事，注重沉浸感，避免任何游戏/数据术语
  - 每个需要描述动作行为的面板之后进行沉浸叙事，将面板行为动作转换叙事，禁止解释与括号说明。
  - 咒语与技能文字美化
  - 以具象化结果与体感描写替代规则术语（如“趔趄”“灼痕”“气浪逼退”“寒霜在指节结晶”）。
  - 场景破坏侧面描写，展现奇幻感与破坏力
</combat_round_protocol>