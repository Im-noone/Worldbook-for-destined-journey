{{setvar::random_event_trigger::
是否需要进行随机事件生成？若无→跳过思考
  若有→严格按照<random_event_trigger_protocol>的generate_step开始在<think></think>中生成事件，禁止跳步，**禁止在正文中掷骰**}}
<random_event_trigger_protocol>
generate_step:
  - step1: 环境状态检查 - 确认是否允许触发任何随机事件
  - step2: 事件类型确认 - 当前应触发<% 
  let random_value = _.random(1, 100); 
  let trigger_random_event = false;
  let event_border_generate = false;
  let current_event_type = "";
  let event_description = "";
  if ( trigger_random_event === false && random_value < 2 && getvar('stat_data.角色.状态.等级') > 13) { 
      trigger_random_event = true
      event_border_generate = true
      current_event_type = "奇遇事件"
      event_description = `根据事件内容填充描述` %>奇遇事件<%
  } else if ( trigger_random_event === false && random_value < 6 && !getvar('stat_data.角色.在军队中')) {
      trigger_random_event = true
      event_border_generate = true
      current_event_type = "随机遭遇战"
      event_description = `根据事件内容填充描述` %>随机遭遇战<%
  } else if ( trigger_random_event === false && random_value < 6 && getvar('stat_data.角色.在军队中') && getvar('stat_data.角色.军队状态') in ['行军', '驻扎']) {
      trigger_random_event = true
      event_border_generate = true
      current_event_type = "战役事件"
      event_description = `根据事件内容填充描述` %>战役事件<%
  } else if ( trigger_random_event === false && random_value < 15 && !getvar('stat_data.角色.在关键对话中') && !getvar('stat_data.角色.在战斗中')) {
      trigger_random_event = true
      event_border_generate = true
      current_event_type = "任务型随机事件"
      event_description = `根据事件内容填充描述` %>任务型随机事件<%
  } else if ( trigger_random_event === false && random_value < 25 && getvar('stat_data.角色.状态.等级') >= 8) { 
      trigger_random_event = true
      event_border_generate = true
      current_event_type = "王国战争事件"
      event_description = `根据事件内容填充描述` %>王国战争事件<%
  } else if ( trigger_random_event === false && random_value < 80 && !getvar('stat_data.角色.在关键对话中') && !getvar('stat_data.角色.在战斗中')) {
      trigger_random_event = true
      event_border_generate = false
      current_event_type = "沉浸感事件" %>沉浸感事件<%
  } 
  
  if (current_event_type === "奇遇事件") { _%>
  - step3: 参考协议 - <legend_event_protocol>
  - step4: 确定奇遇发生的超自然区域类型
  - step5: 从对应区域事件表中挑选id=`1d20`的模板输出事件
  - step6: 基于玩家等级和生命层级调整奇遇挑战
  - step7: 生成超越常规现实的描述和体验
  - step8: 提供概念性、法则性或神性相关的独特奖励
  - step9: 按照<random_event_generate_protocol>生成原则和模板生成对应事件

  <%_ } else if (current_event_type === "随机遭遇战") { _%>
  - step3: 参考协议 - <random_encounter_protocol>
  - step4: 分析等级、装备、技能、资源状态
  - step5: 根据玩家所处环境决定使用哪个对应生成事件的region_type
  - step6: 对应区域事件表中挑选id=`1d20`的模板输出事件
  - step7: 生成事件对应的完整敌人档案
  - step8: 预生成战斗胜利后的奖励
  - step9: 按照<random_event_generate_protocol>生成原则和模板生成对应事件

  <%_ } else if (current_event_type === "战役事件") { _%>
  - step3: 参考协议 - <battlefield_event_protocol>
  - step4: 定地形类型和优劣势，计算敌我双方实力比值，确定当前战斗阶段和士气水平
  - step5: 根据军衔和等级确定决策权重
  - step6: 从对应区域事件表中挑选id=`1d20`的事件模板，根据实际情况调整事件难度
  - step7: 生成50-150字战场描述
  - step8: 提供阶段变化、状态调整等后果
  - step9: 按照<random_event_generate_protocol>生成原则和模板生成对应事件

  <%_ } else if (current_event_type === "任务型随机事件") { _%>
  - step3: 参考协议 - <task_generation_protocol>
  - step4: 确定角色所在区域类型及子区域
  - step5: 根据区域，{{user}}财富，爵位，等级等信息确定可能涉及的势力类型，敌人种类等
  - step6: 从对应区域事件表中挑选id=`1d20`的事件模板
  - step7: 基于角色等级和位置调整任务难度
  - step8: 生成50-200字任务引子描述
  - step9: 调用<任务与委托生成规则>生成一个任务委托

  <%_ } else if ( current_event_type === "王国战争事件") { _%>
  - step3: 参考协议 - <kingdom_war_protocol>
  - step4: 区分安全位置与危险位置
  - step5: 基于爵位和位置生成对应战争事件
  - step6: 考虑友方、敌方或中立势力介入
  - step7: 将战争信息自然融入对话或环境
  - step8: 调用<任务与委托生成规则>生成一个战争招募任务
  
  <%_ } else if (current_event_type === "沉浸感事件") { _%>
  - step3: 参考协议 - <immersion_enhancement_protocol>"
  - step4: 确定角色所在的大区域类型
  - step5: 随机选择或基于上下文确定子区域
  - step6: 从对应区域事件表中挑选id=`1d20`的事件作为模板
  - step7: 考虑季节性、种族或势力因素
  - step8: 根据模板生成50-150字生动感官描述，自然融入正文中,**不生成html包裹的文字**
  <%_ } else { _%>
  - step4: 不生成随机事件
  <%_ } _%>

# 随机事件触发展示栏
event_display_format:
  template: |
    <%_ if (getvar('event_border_generate') === true) { _%>
    <div style="
      border: 2px solid #FFD700;
      border-radius: 8px;
      background: linear-gradient(135deg, #DAA52020, #DAA52060);
      padding: 12px;
      margin: 10px 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    ">
      <div style="display: flex; align-items: center; margin-bottom: 8px;">
        <span style="font-size: 24px; margin-right: 10px;">`添加合适图标icon`</span>
        <span style="font-weight: bold; font-size: 18px; color: #FFF8DC;">getvar('current_event_type')</span>
      </div>
      <div style="
        border-top: 1px solid #FFD70040;
        padding-top: 8px;
        font-size: 14px;
        color: #FFF8DC90;
      ">
        getvar('event_description')
      </div>
    </div>
    <%_ } else { _%>
      自然输出内容，融入在正文中
    <%_ } _%>

output_format:
  event_trigger: "事件触发应自然融入叙事流程，不显式标注概率计算"
  narrative_integration: "所有事件描述必须符合当前环境和剧情背景"
  variable_handling: "状态变化统一在<UpdateVariable>中处理"
  protocol_reference: "事件生成严格遵循对应协议的标准流程"
</random_event_trigger_protocol>